<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCG HEIM Dashboard Self Learning - V3.5 Icon Only</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'shine': 'shine 4s infinite',
                    },
                    keyframes: {
                        shine: {
                            '0%': { left: '-100%', opacity: '0' },
                            '50%': { opacity: '0.5' },
                            '100%': { left: '200%', opacity: '0' },
                        }
                    },
                    colors: { brand: { red: '#ED1C24', dark: '#1e293b' } }
                }
            }
        }
    </script>
    <!-- Fonts & Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --bg-main: #f1f5f9; }
        body { font-family: 'Public Sans', sans-serif; background-color: var(--bg-main); color: #1e293b; height: 100vh; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        .tab-btn { @apply flex items-center justify-center w-10 h-8 rounded-md transition-all duration-300 text-slate-300 hover:text-white hover:bg-white/10 relative; }
        .tab-btn.active { @apply bg-white text-red-600 shadow-lg; }
        
        /* Tooltip style for icon-only buttons */
        .tab-btn:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
        }
        
        .kpi-card { transition: all 0.3s; position: relative; overflow: hidden; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.5); }
        
        /* Table Styles */
        .data-table th { @apply px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-50 sticky top-0 border-b border-slate-200; }
        .data-table td { @apply px-4 py-2.5 whitespace-nowrap text-xs text-slate-700 border-b border-slate-100; }
        .data-table tr:hover td { @apply bg-blue-50/50; }
        
        /* Dropdown Grouping Style */
        optgroup { font-weight: 800; font-style: italic; color: #1e293b; background: #f8fafc; }
        option { font-weight: normal; font-style: normal; padding: 4px; background: white; }
    </style>
</head>
<body class="antialiased flex flex-col">

    <!-- Header -->
    <header class="bg-gradient-to-r from-slate-900 to-slate-800 text-white shadow-lg z-[60] w-full flex-none">
        <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="fireConfetti()">
                <div class="w-9 h-9 bg-red-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-red-600/50 group-hover:scale-110 transition-transform ring-2 ring-white/20">
                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black tracking-tighter uppercase italic leading-none text-white">HEIM OPS</h1>
                    <p class="text-[9px] text-slate-300 font-bold uppercase tracking-widest italic leading-none mt-1">V3.5 Icon Only</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <nav class="bg-white/10 p-1 rounded-lg flex shadow-inner gap-1 backdrop-blur-sm">
                    <button id="tab-overview" onclick="switchTab('overview')" class="tab-btn active" data-tooltip="Overview"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                    <button id="tab-detail" onclick="switchTab('detail')" class="tab-btn" data-tooltip="Records"><i data-lucide="table-2" class="w-4 h-4"></i></button>
                    <button id="tab-dept" onclick="switchTab('dept')" class="tab-btn" data-tooltip="Dept Stats"><i data-lucide="building" class="w-4 h-4"></i></button>
                </nav>
                <div class="h-6 w-px bg-white/20 mx-1"></div>
                <div class="flex items-center gap-2">
                    <button onclick="captureScreen()" class="p-2 bg-white/10 text-slate-300 rounded-lg hover:bg-white hover:text-red-600 transition-all shadow-sm" title="Capture Image"><i data-lucide="camera" class="w-4 h-4"></i></button>
                    <button onclick="toggleImportModal()" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg text-[11px] font-bold shadow-lg shadow-red-600/30 hover:bg-red-500 transition-all hover:-translate-y-0.5"><i data-lucide="database" class="w-3.5 h-3.5"></i> Data Manager</button>
                    <button onclick="clearData()" class="p-2 text-slate-400 hover:text-red-400 transition-colors" title="Clear All Data"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="capture-area" class="max-w-7xl mx-auto w-full flex-1 flex flex-col p-4 gap-4 overflow-hidden pt-6"> <!-- Added pt-6 for more spacing -->
        
        <!-- Filters -->
        <section class="glass-panel rounded-2xl shadow-sm p-3 flex items-center gap-3 flex-none z-50 mb-2"> <!-- Added mb-2 for spacing below filters -->
            <div class="flex items-center gap-3 flex-1">
                <div class="relative min-w-[110px]">
                    <i data-lucide="calendar" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400"></i>
                    <select id="filter-year" onchange="runAnalysis()" class="appearance-none bg-white border border-slate-200 rounded-xl text-[11px] font-bold py-2 pl-9 pr-8 focus:ring-2 focus:ring-red-500/10 outline-none w-full cursor-pointer transition-all shadow-sm">
                        <option value="2026" selected>2026</option><option value="2025">2025</option><option value="2024">2024</option>
                    </select>
                </div>
                <div class="relative min-w-[140px]">
                    <i data-lucide="clock" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400"></i>
                    <select id="filter-month" onchange="runAnalysis()" class="appearance-none bg-white border border-slate-200 rounded-xl text-[11px] font-bold py-2 pl-9 pr-8 focus:ring-2 focus:ring-red-500/10 outline-none w-full cursor-pointer transition-all shadow-sm">
                        <option value="ALL" selected>All Months</option>
                        <option value="01">January</option><option value="02">February</option><option value="03">March</option><option value="04">April</option>
                        <option value="05">May</option><option value="06">June</option><option value="07">July</option><option value="08">August</option>
                        <option value="09">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
                    </select>
                </div>
                <div class="relative flex-[2]">
                    <i data-lucide="building-2" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400"></i>
                    <select id="filter-dept" onchange="runAnalysis()" class="appearance-none bg-white border border-slate-200 rounded-xl text-[11px] font-bold py-2 pl-9 pr-8 focus:ring-2 focus:ring-red-500/10 outline-none w-full cursor-pointer transition-all shadow-sm">
                        <option value="All">All Departments</option>
                    </select>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="relative w-64">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400"></i>
                    <input id="search-term" oninput="runAnalysis()" type="text" placeholder="Search name..." class="w-full bg-white border border-slate-200 rounded-xl text-[11px] font-bold py-2 pl-9 pr-4 focus:ring-2 focus:ring-red-500/10 outline-none transition-all shadow-sm">
                </div>
                <button onclick="resetFilters()" class="p-2 bg-slate-100 hover:bg-slate-200 text-slate-500 rounded-xl transition-colors" title="Reset Filters"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
            </div>
        </section>

        <!-- Tab: Overview -->
        <div id="content-overview" class="flex-1 flex flex-col gap-4 overflow-hidden animate-in fade-in duration-300">
            <!-- KPIs -->
            <div class="grid grid-cols-5 gap-3 flex-none">
                <div class="bg-white p-4 rounded-2xl shadow-sm kpi-card flex items-center gap-4 group">
                    <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center flex-none group-hover:scale-110 transition-transform"><i data-lucide="database" class="w-6 h-6 text-slate-400"></i></div>
                    <div><p class="text-[9px] font-black text-slate-400 uppercase italic tracking-wider">Total Records</p><h3 id="stat-total" class="text-2xl font-black text-slate-800 mt-0.5">0</h3></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm kpi-card flex items-center gap-4 group">
                    <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center flex-none group-hover:scale-110 transition-transform"><i data-lucide="check-circle-2" class="w-6 h-6 text-emerald-500"></i></div>
                    <div><p class="text-[9px] font-black text-slate-400 uppercase italic tracking-wider">Completed</p><h3 id="stat-active" class="text-2xl font-black text-emerald-600 mt-0.5">0</h3></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm kpi-card flex items-center gap-4 group">
                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center flex-none group-hover:scale-110 transition-transform"><i data-lucide="activity" class="w-6 h-6 text-blue-500"></i></div>
                    <div><p class="text-[9px] font-black text-slate-400 uppercase italic tracking-wider">Avg. per Person</p><h3 id="stat-avg" class="text-2xl font-black text-blue-600 mt-0.5">0.0</h3></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm kpi-card flex items-center gap-4 group">
                    <div class="w-12 h-12 bg-purple-50 rounded-2xl flex items-center justify-center flex-none group-hover:scale-110 transition-transform"><i data-lucide="pie-chart" class="w-6 h-6 text-purple-500"></i></div>
                    <div><p class="text-[9px] font-black text-slate-400 uppercase italic tracking-wider">Active Rate</p><h3 id="stat-rate" class="text-2xl font-black text-purple-600 mt-0.5">0%</h3></div>
                </div>
                <div class="bg-slate-800 p-4 rounded-2xl shadow-sm kpi-card flex items-center gap-4 group relative overflow-hidden">
                    <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-slate-700 rounded-full opacity-20"></div>
                    <div class="w-12 h-12 bg-slate-700/50 rounded-2xl flex items-center justify-center flex-none group-hover:scale-110 transition-transform"><i data-lucide="user-x" class="w-6 h-6 text-red-400 animate-pulse-slow"></i></div>
                    <div class="relative z-10">
                        <p class="text-[9px] font-black text-slate-400 uppercase italic tracking-wider">Pending Users</p>
                        <h3 id="stat-inactive" class="text-2xl font-black text-white mt-0.5">0</h3>
                    </div>
                </div>
            </div>

            <div class="flex-1 grid grid-cols-12 gap-4 overflow-hidden">
                <div class="col-span-8 flex flex-col gap-4">
                    <div class="grid grid-cols-2 gap-4 h-[160px] flex-none">
                        <div class="bg-gradient-to-br from-slate-900 to-slate-800 text-white p-5 rounded-[2rem] shadow-xl relative overflow-hidden flex flex-col justify-between border border-slate-700 group">
                            <i data-lucide="crown" class="absolute top-2 right-2 w-24 h-24 text-yellow-500 opacity-10 group-hover:rotate-12 transition-transform duration-700"></i>
                            <div>
                                <span class="px-2 py-0.5 bg-yellow-400 text-slate-900 text-[9px] font-black uppercase italic rounded-full shadow-lg">Overall Champion</span>
                                <h2 id="winner-name" class="text-2xl font-black italic uppercase truncate leading-tight mt-2">-</h2>
                                <p id="winner-dept" class="text-slate-400 font-bold text-[10px] truncate mt-1 opacity-80">-</p>
                            </div>
                            <div class="flex items-center justify-between border-t border-slate-700 pt-3">
                                <div><p class="text-[9px] text-slate-400 italic uppercase">Total Records</p><h3 id="winner-hits" class="text-3xl font-black italic text-yellow-400">0</h3></div>
                                <div class="bg-white/10 p-2 rounded-xl"><i data-lucide="trophy" class="w-6 h-6 text-yellow-400"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-[2rem] shadow-sm flex flex-col justify-between overflow-hidden group border border-slate-100 relative">
                             <div class="absolute top-0 right-0 w-24 h-24 bg-red-50 rounded-full -mr-8 -mt-8 transition-transform group-hover:scale-150"></div>
                             <div class="relative z-10">
                                <span id="early-month-label" class="px-2 py-0.5 bg-red-600 text-white text-[9px] font-black uppercase italic rounded-full shadow-lg">-</span>
                                <h2 id="early-name" class="text-2xl font-black italic uppercase truncate leading-tight mt-2 text-slate-800">-</h2>
                                <p id="early-time" class="text-red-600 font-black text-[10px] italic mt-1 truncate">First: -</p>
                             </div>
                             <div class="flex items-center justify-between border-t border-slate-100 pt-3 relative z-10">
                                <p class="text-[10px] font-bold text-slate-400 italic uppercase">Monthly Speed Star</p>
                                <div class="bg-red-50 p-2 rounded-xl group-hover:bg-red-100 transition-colors"><i data-lucide="zap" class="w-6 h-6 text-red-500"></i></div>
                             </div>
                        </div>
                    </div>
                    
                    <div class="flex-1 bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 flex flex-col min-h-0 relative">
                        <div class="flex items-center justify-between mb-4 flex-none">
                            <h3 class="text-[12px] font-black uppercase italic text-slate-800">Top Learners (Individual)</h3>
                            <div class="bg-slate-100 p-1 rounded-xl flex items-center">
                                <button onclick="setChartMode('user')" id="btn-mode-user" class="px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all shadow-sm bg-white text-slate-800">Individual</button>
                                <button onclick="setChartMode('dept')" id="btn-mode-dept" class="px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all text-slate-400 hover:text-slate-600">Department</button>
                            </div>
                        </div>
                        <div class="flex-1 min-h-0 relative"><canvas id="learnerChart"></canvas></div>
                    </div>
                </div>

                <div class="col-span-4 bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 flex flex-col overflow-hidden h-full">
                    <div class="flex items-center justify-between mb-4 px-1 flex-none">
                        <div><h3 class="text-[12px] font-black uppercase italic text-slate-800">Pending List</h3><p class="text-[9px] text-slate-400 font-bold mt-0.5">Employees yet to complete</p></div>
                        <button onclick="exportData()" class="w-8 h-8 flex items-center justify-center bg-emerald-50 text-emerald-600 rounded-xl hover:bg-emerald-500 hover:text-white transition-all shadow-sm" title="Export All Data"><i data-lucide="download" class="w-4 h-4"></i></button>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-2 mb-2 flex items-center justify-between"><span class="text-[9px] font-bold text-slate-400 uppercase">Total Pending</span><span id="pending-count-label" class="text-[11px] font-black text-slate-700 bg-white px-2 py-0.5 rounded-lg shadow-sm">0</span></div>
                    <div id="inactive-list-summary" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-1"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Detail Table -->
        <div id="content-detail" class="hidden flex-1 flex flex-col bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden animate-in fade-in duration-300">
             <div class="p-5 border-b border-slate-100 flex items-center justify-between flex-none bg-white z-10">
                 <div><h3 class="text-lg font-black uppercase italic text-slate-800">Learning Records</h3><p class="text-xs text-slate-400 font-bold">All learning activities</p></div>
                 <div class="flex items-center gap-2">
                     <span id="table-info" class="text-xs text-slate-500 font-bold">Showing 0-0 of 0</span>
                     <div class="flex gap-1">
                         <button onclick="changePage(-1)" class="p-1.5 rounded-lg border hover:bg-slate-50"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                         <button onclick="changePage(1)" class="p-1.5 rounded-lg border hover:bg-slate-50"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                     </div>
                 </div>
             </div>
             <div class="flex-1 overflow-auto custom-scrollbar relative">
                 <table class="w-full data-table">
                     <thead><tr><th>Date</th><th>Name</th><th>Department (New)</th><th>Topic/Type</th></tr></thead>
                     <tbody id="records-table-body"></tbody>
                 </table>
             </div>
        </div>

        <!-- Tab: Department Stats -->
        <div id="content-dept" class="hidden flex-1 flex flex-col bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden animate-in fade-in duration-300">
            <div class="p-5 border-b border-slate-100 flex-none bg-white z-10">
                <h3 class="text-lg font-black uppercase italic text-slate-800">Department Statistics</h3><p class="text-xs text-slate-400 font-bold">Performance by Dept (Sorted by %)</p>
            </div>
            <div class="flex-1 overflow-auto custom-scrollbar p-5">
                <table class="w-full data-table rounded-xl overflow-hidden border border-slate-200">
                    <thead class="bg-slate-100"><tr><th>Department Name (New)</th><th class="text-center">Total Members</th><th class="text-center">Learned</th><th class="text-right">% Completion</th></tr></thead>
                    <tbody id="dept-table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="toggleImportModal()"></div>
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl p-8 relative z-10 animate-in zoom-in-95 duration-300">
            <div class="flex items-center justify-between mb-8"><h3 class="text-xl font-black text-slate-800 italic uppercase">Data Management</h3><button onclick="toggleImportModal()" class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center hover:bg-red-50 text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></div>
            <div class="grid grid-cols-2 gap-4">
                <div onclick="document.getElementById('file-members').click()" class="bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200 cursor-pointer hover:border-red-500 hover:bg-red-50 text-center group"><i data-lucide="users" class="w-8 h-8 text-slate-400 group-hover:text-red-500 mx-auto mb-3"></i><p class="font-black text-slate-700 text-[10px] uppercase">Import Members</p><input type="file" id="file-members" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleFile(event, 'members')"></div>
                <div onclick="document.getElementById('file-records').click()" class="bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200 cursor-pointer hover:border-red-500 hover:bg-red-50 text-center group"><i data-lucide="history" class="w-8 h-8 text-slate-400 group-hover:text-red-500 mx-auto mb-3"></i><p class="font-black text-slate-700 text-[10px] uppercase">Import Records</p><input type="file" id="file-records" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleFile(event, 'records')"></div>
            </div>
            <div class="relative py-4"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-100"></div></div><div class="relative flex justify-center"><span class="bg-white px-2 text-[10px] text-slate-400 font-bold uppercase">OR</span></div></div>
            <button onclick="loadDemoData()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-xs uppercase hover:bg-black flex items-center justify-center gap-2"><i data-lucide="play-circle" class="w-4 h-4 text-emerald-400"></i> Load Demo Data</button>
        </div>
    </div>

    <script>
        let members = [], records = [], pendingList = [], tendencyChart, learnerChart;
        let filteredRecords = []; // For table view
        let currentPage = 1;
        const itemsPerPage = 50;
        let currentChartMode = 'user';
        
        const DEFAULT_DEPT = "SCG HEIM Factory/Product Development and Supply Chain Department";
        const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const MONTH_SHORT = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        window.onload = function() { lucide.createIcons(); loadFromStorage(); runAnalysis(); };

        function switchTab(tab) {
            ['overview', 'detail', 'dept'].forEach(t => {
                 document.getElementById('content-' + t)?.classList.add('hidden');
                 document.getElementById('tab-' + t)?.classList.remove('active');
            });
            document.getElementById('content-' + tab)?.classList.remove('hidden');
            document.getElementById('tab-' + tab)?.classList.add('active');
            
            if(tab === 'overview') runAnalysis();
            if(tab === 'detail') renderTable();
            if(tab === 'dept') renderDeptStats();
        }

        function toggleImportModal() { document.getElementById('import-modal').classList.toggle('hidden'); }
        function fireConfetti() { confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#ED1C24', '#ffffff', '#1e293b'] }); }
        
        function resetFilters() {
            document.getElementById('filter-year').value = "2026";
            document.getElementById('filter-month').value = "ALL";
            document.getElementById('filter-dept').value = "All";
            document.getElementById('search-term').value = "";
            runAnalysis();
        }

        function setChartMode(mode) { currentChartMode = mode; runAnalysis(); }

        function animateValue(objId, start, end, duration, suffix = "") {
            const obj = document.getElementById(objId); if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerText = Math.floor(progress * (end - start) + start).toLocaleString() + suffix;
                if (progress < 1) window.requestAnimationFrame(step); else obj.innerText = end.toLocaleString() + suffix;
            };
            window.requestAnimationFrame(step);
        }

        // --- Demo Data ---
        function loadDemoData() {
            const depts = ["Sales > Retail", "Management > HR", "IT > Support", "Production > Line 1", "Logistics"];
            const demoM = []; const demoR = [];
            for (let i = 0; i < 50; i++) demoM.push({ name: `Employee ${i+1}`, dept: depts[Math.floor(Math.random() * depts.length)] });
            const today = new Date();
            for (let i = 0; i < 150; i++) {
                const member = demoM[Math.floor(Math.random() * demoM.length)];
                demoR.push({ Name: member.name, Department: member.dept, CreatedDateTime: new Date(today.getTime() - Math.random() * 63072000000).toISOString().split('T')[0], Topic: "Safety Training" });
            }
            members = demoM; records = demoR;
            localStorage.setItem('scg_heim_members_v33', JSON.stringify(members));
            localStorage.setItem('scg_heim_records_v33', JSON.stringify(records));
            populateDepts(); runAnalysis(); toggleImportModal(); fireConfetti();
        }

        // --- Data Handling ---
        const normalizeKey = (key) => key.toLowerCase().trim().replace(/[\s\-_]/g, '');

        function handleFile(event, type) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    if(type === 'members') {
                        members = rawData.map(row => {
                            const keys = Object.keys(row);
                            const nameKey = keys.find(k => normalizeKey(k).includes('name') || normalizeKey(k).includes('ชื่อ'));
                            
                            // Prioritize "Department New" > "Department" > "Old Department"
                            const deptNewKey = keys.find(k => normalizeKey(k).includes('departmentnew'));
                            const deptKey = keys.find(k => normalizeKey(k) === 'department' || normalizeKey(k) === 'แผนก');
                            const deptOldKey = keys.find(k => normalizeKey(k).includes('olddepartment'));
                            
                            const finalDeptKey = deptNewKey || deptKey || deptOldKey;

                            return { name: String(row[nameKey] || "").trim(), dept: String(row[finalDeptKey] || "").trim() };
                        }).filter(m => m.name && m.name !== "undefined");
                        localStorage.setItem('scg_heim_members_v33', JSON.stringify(members));
                    } else {
                        // Clear demo
                        if (members.length > 0 && members[0].name.startsWith("Employee ")) { members = []; localStorage.removeItem('scg_heim_members_v33'); }

                        records = rawData.map(row => {
                            const keys = Object.keys(row);
                            const nameKey = keys.find(k => normalizeKey(k).includes('name') || normalizeKey(k).includes('ชื่อ'));
                            const deptKey = keys.find(k => normalizeKey(k).includes('dept') || normalizeKey(k).includes('แผนก'));
                            const dateKey = keys.find(k => normalizeKey(k).includes('createddatetime') || normalizeKey(k).includes('time') || normalizeKey(k).includes('date'));
                            const topicKey = keys.find(k => normalizeKey(k).includes('topic') || normalizeKey(k).includes('subject'));
                            
                            let dateStr = row[dateKey], formattedDate = "";
                            if (typeof dateStr === 'number') formattedDate = new Date((dateStr - (25567 + 2)) * 86400 * 1000).toISOString().split('T')[0];
                            else if (dateStr instanceof Date) formattedDate = dateStr.toISOString().split('T')[0];
                            else if (dateStr) formattedDate = String(dateStr).trim().split(' ')[0];
                            
                            let recordName = String(row[nameKey] || "").trim();
                            let recordDept = String(row[deptKey] || "").trim();

                            // SYNC: Lookup member to get correct Department New
                            const matchedMember = members.find(m => m.name === recordName);
                            if (matchedMember) {
                                recordDept = matchedMember.dept;
                            }

                            return { 
                                Name: recordName, 
                                Department: recordDept, 
                                CreatedDateTime: formattedDate,
                                Topic: String(row[topicKey] || "-")
                            };
                        }).filter(r => r.Name && r.Name !== "undefined");
                        localStorage.setItem('scg_heim_records_v33', JSON.stringify(records));
                    }
                    populateDepts(); runAnalysis(); toggleImportModal(); fireConfetti();
                } catch (err) { console.error(err); alert("Error processing file."); }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportData() {
            if (records.length === 0) { alert("No data to export."); return; }
            const wb = XLSX.utils.book_new();
            const wsPending = XLSX.utils.json_to_sheet(pendingList.map(p => ({ "Name": p.name, "Department": p.dept, "Status": "Pending" })));
            XLSX.utils.book_append_sheet(wb, wsPending, "Pending List");
            const wsRecords = XLSX.utils.json_to_sheet(records);
            XLSX.utils.book_append_sheet(wb, wsRecords, "All Records");
            XLSX.writeFile(wb, `SCG_HEIM_Dashboard_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function loadFromStorage() {
            try {
                const m = localStorage.getItem('scg_heim_members_v33'), r = localStorage.getItem('scg_heim_records_v33');
                if(m) members = JSON.parse(m); if(r) records = JSON.parse(r);
                populateDepts();
            } catch (e) { localStorage.clear(); }
        }
        
        function clearData() { if(confirm("Clear all data?")) { localStorage.clear(); location.reload(); } }

        function populateDepts() {
            const allDepts = ["All", ...new Set([...members.map(m => m.dept), ...records.map(r => r.Department)])].filter(d => d).sort();
            const select = document.getElementById('filter-dept');
            
            if(select) {
                const currentVal = select.value;
                select.innerHTML = ''; 
                
                const allOpt = document.createElement('option');
                allOpt.value = "All"; allOpt.text = "All Departments"; select.appendChild(allOpt);

                const groups = {};
                allDepts.filter(d => d !== "All").forEach(d => {
                    let groupName = "Others";
                    if (d.includes(" > ")) {
                        groupName = d.split(" > ")[0].trim();
                    } else if (d.includes("/")) {
                        const parts = d.split(/\/+/);
                        groupName = parts.length > 1 ? parts[0].trim() : "Others";
                    }
                    
                    if (!groups[groupName]) groups[groupName] = [];
                    groups[groupName].push(d);
                });

                Object.keys(groups).sort().forEach(groupName => {
                    if(groupName === "Others") return;
                    const grp = document.createElement('optgroup'); grp.label = groupName;
                    groups[groupName].forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.text = d; grp.appendChild(opt); });
                    select.appendChild(grp);
                });

                if (groups["Others"]) {
                    const grp = document.createElement('optgroup'); grp.label = "Other Departments";
                    groups["Others"].forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.text = d; grp.appendChild(opt); });
                    select.appendChild(grp);
                }

                if (currentVal && allDepts.includes(currentVal)) select.value = currentVal;
            }
        }

        async function captureScreen() {
            const captureArea = document.getElementById('capture-area');
            const btn = document.querySelector('[title="Capture Image"]');
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
            try {
                await new Promise(r => setTimeout(r, 100));
                const canvas = await html2canvas(captureArea, { scale: 2, backgroundColor: '#f1f5f9', useCORS: true, logging: false });
                const link = document.createElement('a');
                link.download = `HEIM-Report-V3.3-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png'); link.click();
            } finally { btn.innerHTML = '<i data-lucide="camera" class="w-4 h-4"></i>'; lucide.createIcons(); }
        }

        // --- Core Analysis ---
        function runAnalysis() {
            const year = document.getElementById('filter-year').value;
            const month = document.getElementById('filter-month').value;
            const dept = document.getElementById('filter-dept').value;
            const search = document.getElementById('search-term').value.toLowerCase();

            filteredRecords = records.filter(r => {
                if(!r.CreatedDateTime) return false;
                const dt = String(r.CreatedDateTime);
                return dt.startsWith(year) && (month === 'ALL' || dt.includes(`-${month}-`)) && (dept === 'All' || r.Department === dept) && r.Name.toLowerCase().includes(search);
            });

            let effectiveMembers = members;
            if (members.length === 0 && records.length > 0) {
                 const uniqueUsers = new Map();
                 records.forEach(r => { if (!uniqueUsers.has(r.Name)) uniqueUsers.set(r.Name, { name: r.Name, dept: r.Department }); });
                 effectiveMembers = Array.from(uniqueUsers.values());
            }

            const targetPool = effectiveMembers.filter(m => dept === 'All' || m.dept === dept);
            const activeNames = new Set(filteredRecords.map(r => r.Name));
            const activeCount = targetPool.filter(m => activeNames.has(m.name)).length;
            const inactiveCount = Math.max(0, targetPool.length - activeCount);

            animateValue('stat-total', parseInt(document.getElementById('stat-total').innerText.replace(/,/g,'')), filteredRecords.length, 800);
            animateValue('stat-active', parseInt(document.getElementById('stat-active').innerText.replace(/,/g,'')), activeCount, 800);
            document.getElementById('stat-avg').innerText = activeCount > 0 ? (filteredRecords.length / activeCount).toFixed(1) : "0.0";
            const rate = targetPool.length > 0 ? Math.round((activeCount / targetPool.length) * 100) : 0;
            animateValue('stat-rate', parseInt(document.getElementById('stat-rate').innerText.replace('%','')), rate, 800, "%");
            animateValue('stat-inactive', parseInt(document.getElementById('stat-inactive').innerText.replace(/,/g,'')), inactiveCount, 800);
            document.getElementById('pending-count-label').innerText = inactiveCount.toLocaleString();

            const userCounts = {}; filteredRecords.forEach(r => userCounts[r.Name] = (userCounts[r.Name] || 0) + 1);
            const sortedUsers = Object.entries(userCounts).map(([name, count]) => ({ name, count, dept: (effectiveMembers.find(m => m.name === name) || {}).dept || "N/A" })).sort((a,b) => b.count - a.count);
            const winner = sortedUsers[0];
            document.getElementById('winner-name').innerText = winner ? winner.name : "-";
            document.getElementById('winner-dept').innerText = winner ? winner.dept : "-";
            document.getElementById('winner-hits').innerText = winner ? winner.count : "0";

            const first = [...filteredRecords].sort((a,b) => new Date(a.CreatedDateTime) - new Date(b.CreatedDateTime))[0];
            if(first) {
                document.getElementById('early-month-label').innerText = month === 'ALL' ? 'Annual' : MONTH_NAMES[parseInt(month) - 1];
                document.getElementById('early-name').innerText = first.Name;
                document.getElementById('early-time').innerText = `Date: ${first.CreatedDateTime}`;
            } else { document.getElementById('early-name').innerText = "-"; document.getElementById('early-time').innerText = "No Records"; }

            pendingList = targetPool.filter(m => !activeNames.has(m.name));
            let pendingHTML = "";
            if (pendingList.length > 0) {
                 pendingHTML = pendingList.slice(0, 100).map(m => `
                <div class="flex items-center justify-between p-2.5 bg-white rounded-xl border border-slate-100 hover:border-red-200 transition-all group">
                    <div class="truncate"><p class="text-[10px] font-bold text-slate-700 truncate leading-none group-hover:text-red-600 transition-colors">${m.name}</p><p class="text-[9px] text-slate-400 font-bold uppercase mt-1 truncate">${m.dept}</p></div>
                    <div class="w-1.5 h-1.5 rounded-full bg-orange-400 animate-pulse"></div>
                </div>`).join('') + (pendingList.length > 100 ? `<div class="text-center text-[9px] text-slate-400 pt-2">...and ${pendingList.length - 100} more</div>` : '');
            } else if (targetPool.length > 0) {
                 pendingHTML = '<div class="text-center py-10 opacity-40 text-[10px] font-bold flex flex-col items-center gap-2"><i data-lucide="check-check" class="w-8 h-8 text-emerald-500"></i>ALL COMPLETED</div>';
            } else { pendingHTML = '<div class="text-center py-10 opacity-40 text-[10px] font-bold">No Data</div>'; }
            document.getElementById('inactive-list-summary').innerHTML = pendingHTML;

            renderCharts(sortedUsers, targetPool, year);
            if(document.getElementById('tab-detail').classList.contains('active')) renderTable();
            if(document.getElementById('tab-dept').classList.contains('active')) renderDeptStats();
            lucide.createIcons();
        }

        function changePage(delta) {
            const maxPage = Math.ceil(filteredRecords.length / itemsPerPage);
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= maxPage) { currentPage = newPage; renderTable(); }
        }

        function renderTable() {
            const tbody = document.getElementById('records-table-body');
            tbody.innerHTML = '';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredRecords.slice(start, end);
            document.getElementById('table-info').innerText = `Showing ${filteredRecords.length > 0 ? start + 1 : 0}-${Math.min(end, filteredRecords.length)} of ${filteredRecords.length}`;
            if(pageData.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-slate-400 text-xs">No records found</td></tr>'; return; }
            pageData.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.CreatedDateTime}</td><td class="font-bold">${r.Name}</td><td class="text-slate-500 truncate max-w-[200px]" title="${r.Department}">${r.Department}</td><td class="truncate max-w-[250px]">${r.Topic}</td>`;
                tbody.appendChild(tr);
            });
        }

        function renderDeptStats() {
            const tbody = document.getElementById('dept-table-body');
            tbody.innerHTML = '';
            let effectiveMembers = members;
            if (members.length === 0 && records.length > 0) {
                 const uniqueUsers = new Map();
                 records.forEach(r => { if (!uniqueUsers.has(r.Name)) uniqueUsers.set(r.Name, { name: r.Name, dept: r.Department }); });
                 effectiveMembers = Array.from(uniqueUsers.values());
            }
            const deptStats = {};
            const allDepts = [...new Set(effectiveMembers.map(m => m.dept))];
            allDepts.forEach(d => deptStats[d] = { total: 0, active: 0 });
            effectiveMembers.forEach(m => { if(deptStats[m.dept]) deptStats[m.dept].total++; });
            const year = document.getElementById('filter-year').value;
            const activeInFiltered = new Set();
            records.filter(r => r.CreatedDateTime.startsWith(year)).forEach(r => {
                const user = effectiveMembers.find(m => m.name === r.Name);
                if(user && !activeInFiltered.has(user.name)) { activeInFiltered.add(user.name); if(deptStats[user.dept]) deptStats[user.dept].active++; }
            });
            const sortedDepts = Object.entries(deptStats).map(([name, stats]) => ({ name, ...stats, rate: stats.total > 0 ? (stats.active/stats.total*100) : 0 })).sort((a,b) => b.rate - a.rate);
            sortedDepts.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="font-bold text-slate-700" title="${d.name}">${d.name}</td><td class="text-center">${d.total}</td><td class="text-center text-emerald-600 font-bold">${d.active}</td><td class="text-right font-black ${d.rate >= 80 ? 'text-emerald-500' : d.rate < 50 ? 'text-red-500' : 'text-orange-500'}">${d.rate.toFixed(1)}%</td>`;
                tbody.appendChild(tr);
            });
        }

        function renderCharts(topUsers, targetPool, targetYear) {
            const ctxL = document.getElementById('learnerChart');
            if(learnerChart) learnerChart.destroy();
            let chartData, chartOptions;
            if (currentChartMode === 'user') {
                 const top10 = topUsers.slice(0, 10);
                 chartData = { labels: top10.map(u => u.name), datasets: [{ data: top10.map(u => u.count), backgroundColor: '#ef4444', borderRadius: 4, barThickness: 10 }] };
                 chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { font: { size: 9 }, color: '#64748b' }, grid: { display: false } } } };
            } else {
                const deptStats = {};
                targetPool.forEach(m => { if(!deptStats[m.dept]) deptStats[m.dept] = { total: 0, active: 0 }; deptStats[m.dept].total++; });
                const activeInFiltered = new Set();
                records.filter(r => r.CreatedDateTime.startsWith(targetYear)).forEach(r => {
                     const user = targetPool.find(m => m.name === r.Name);
                     if(user && !activeInFiltered.has(user.name)) { activeInFiltered.add(user.name); deptStats[user.dept].active++; }
                });
                const sorted = Object.entries(deptStats).map(([name, stats]) => ({ name, rate: stats.total > 0 ? (stats.active/stats.total*100) : 0 })).sort((a,b) => b.rate - a.rate).slice(0, 8);
                chartData = { labels: sorted.map(d => d.name.length > 15 ? d.name.substring(0,15)+'...' : d.name), datasets: [{ data: sorted.map(d => d.rate), backgroundColor: '#3b82f6', borderRadius: 4, barThickness: 10 }] };
                chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => c.raw.toFixed(1) + '%' } } }, scales: { x: { max: 100, display: false }, y: { ticks: { font: { size: 9 }, color: '#64748b' }, grid: { display: false } } } };
            }
            learnerChart = new Chart(ctxL, { type: 'bar', data: chartData, options: chartOptions });
        }
    </script>
</body>
</html>
